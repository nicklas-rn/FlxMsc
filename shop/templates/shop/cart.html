{% extends "shop/base.html" %}
{% load static %}


{% block content %}

<h3 class="page-title cart-title">Cart</h3>
<article class="cart-content">
    {% for item in items %}
        <div class="cart-item">
            <div class="item-price-container"></div>
            <p class="beat-title">{{ item.product.title }}</p>
            <p class="beat-price">{{ item.product.price }}€</p>
            <br>
            <p class="beat-license">{{ item.product.license }}</p>
            <button class="remove-button update-cart" data-beat="{{item.product.id}}" data-license="{{item.product.license}}" data-action="remove">
                 <i class="fas fa-times remove-icon"></i>Remove
            </button>
        </div>
    {% endfor %}
    <div class="total-container">
        <p class="total total-title">Total</p><p class="total total-price">{{ order.get_cart_total }}€</p>
    </div>
    <div id="paypal-button-container"></div>
    <div class="error-container" id="error-container">
        <p class="error-message">Your payment couldn't be processed. Please try again later</p>
    </div>

</article>


<!-- Include the PayPal JavaScript SDK -->
<script src="https://www.paypal.com/sdk/js?client-id=sb&currency=EUR&disable-funding=credit,card,sofort,giropay,sepa"></script>

<script>
    function getCsrfCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCsrfCookie('csrftoken');
    var url = {% url 'process_order' %}


    // Render the PayPal button into #paypal-button-container
    paypal.Buttons({

        // Set up the transaction
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: '{{ order.get_cart_total }}'
                    },
                }]
            });
        },

        // Finalize the transaction
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
                console.log(details)
                sendData(details)
                function sendData(details){
                    fetch(url,{
                            method:"POST",
                            headers:{
                                "Content-type": 'application/json',
                                "X-CSRFToken": csrftoken,
                            },
                            body: JSON.stringify({
                                payerFirstName: details.payer.name.given_name,
                                payerLastName: details.payer.name.surname,
                                payerEmailAddress: details.payer.email_address,
                                payerId: details.payer.payer_id,
                                transactionId: details.id,
                                })
                        }
                    )
                }
                addCookieTransactionId(details.id)
                console.log(details.payer.name.given_name)
            });
        },

        onError: function(err){
            paypalErrorMessage()
        }

    }).render('#paypal-button-container');
</script>




<link rel="stylesheet" type="text/css" href="{% static 'shop/cart_style.css' %}">
<script src="{% static 'shop/animations.js' %}"></script>

{% endblock %}